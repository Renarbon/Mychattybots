<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ESL ChattyBot ‚Äì Fast Food Restaurant (Cashier Version, Lemonfox Voice)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f2f2f2; }
    #chat { background: white; padding: 20px; max-width: 700px; margin: auto; border-radius: 10px; }
    .message { margin: 10px 0; }
    .user { color: green; }
    .bot { color: blue; }
    input, button { padding: 10px; margin: 5px; }
    input[readonly] { background-color: #eee; }
    #studentInput { width: 90%; padding: 8px; }
  </style>
</head>
<body>
  <div id="chat">
    <h2>üçî ESL ChattyBot ‚Äì Fast Food Restaurant (Cashier Version, Lemonfox Voice)</h2>
    <label>Student Name: <input id="studentName" type="text" /></label><br>
    <label>Date: <input id="sessionDate" type="date" /></label><br>
    <div style="margin: 12px 0; color: #007aff; background: #e6e6ff; border-radius: 6px; padding: 8px; max-width: 600px;">
      <b>Instructions:</b> You are the cashier. Please read the <span style="color: #007aff;">green</span>
      part aloud each turn. ChattyBot will play the customer.
    </div>
    <div id="promptLine" style="margin: 10px 0; color: #555; background: #eee; border-radius: 6px; padding: 8px;">
      Please say: <span id="promptText"></span>
    </div>
    <div id="conversation"></div>
    <button onclick="startRecording()" id="recordButton">üéôÔ∏è Record</button>
    <button onclick="submitStudentResponse()" id="sendButton" disabled>üì® Send</button>
    <input type="text" id="studentInput" readonly />
    <button onclick="downloadPDF()">‚¨áÔ∏è Download PDF</button>
  </div>
  <script>
    // === ENSURE CORRECT CHAT START ===
    window.onload = () => {
      conversationDiv.innerHTML = "";
      transcript.length = 0;
      currentLine = 0;
      tempUserText = "";
      document.getElementById("studentInput").value = "";
      document.getElementById("sendButton").disabled = true;
      updatePrompt();
    };
    // === CONFIG: Set your backend URL here ===
    const BASE_URL = "https://chattybot-backend.onrender.com";
    const LEMONFOX_PROXY_URL = `${BASE_URL}/api/lemonfox-tts`;
    const LEMONFOX_VOICE = "adam"; // Change voice here if you like

    // === SCRIPT DATA ===
    // Student (cashier) lines ‚Äì green
    const scriptLines = [
      "Hello! Welcome to Burger Place. May I take your order?",
      "Would you like fries or a drink with that?",
      "Is that for here or to go?",
      "Can I have your name for the order, please?",
      "Your total is $7 and 50 cents. How would you like to pay?",
      "Thank you! Please wait while we prepare your order."
    ];
    // Bot (customer) lines ‚Äì blue
    const botLines = [
      "Yes, I‚Äôd like a cheeseburger, please.",
      "Just fries, thank you.",
      "To go, please.",
      "My name is Andy.",
      "With my credit card.",
      "Thank you!"
    ];

    // === STATE ===
    const transcript = [];
    const conversationDiv = document.getElementById('conversation');
    let currentLine = 0;
    let tempUserText = "";

    function updatePrompt() {
      document.getElementById("promptText").textContent = scriptLines[currentLine] || '';
    }

    // --- Lemonfox via backend proxy ---
    async function speak(text) {
      try {
        const response = await fetch(LEMONFOX_PROXY_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text, voice: LEMONFOX_VOICE })
        });
        if (!response.ok) {
          alert("Lemonfox error: " + response.status + " - " + response.statusText);
          return;
        }
        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        const audio = new Audio(audioUrl);
        audio.play();
      } catch (e) {
        alert("Lemonfox error: " + e);
      }
    }

    function startRecording() {
      const recog = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recog.lang = 'en-US'; recog.interimResults = false; recog.maxAlternatives = 1;
      recog.start();
      recog.onresult = e => {
        tempUserText = e.results[0][0].transcript;
        document.getElementById("studentInput").value = tempUserText;
        document.getElementById("sendButton").disabled = false;
      };
      recog.onerror = e => alert("Speech recognition error: " + e.error);
    }

    function submitStudentResponse() {
      if (!tempUserText) return;
      const expected = scriptLines[currentLine];
      addMessage('user', tempUserText);

      // Bot replies with the matching customer line for this step
      if (currentLine < botLines.length) {
        setTimeout(() => {
          addMessage('bot', botLines[currentLine]);
          speak(botLines[currentLine]);
        }, 900);
      }

      currentLine++; // Only increment after both have spoken

      // End of conversation check
      if (currentLine >= scriptLines.length) {
        setTimeout(() => {
          addMessage('bot', "bye! See you next time.");
          speak("bye! See you next time.");
        }, 1200);
        updatePrompt();
      } else {
        updatePrompt();
      }

      document.getElementById("studentInput").value = "";
      tempUserText = "";
      document.getElementById("sendButton").disabled = true;
    }

    // === DOM HELPERS ===
    function addMessage(who, text) {
      const d = document.createElement('div');
      d.className = `message ${who}`;
      d.textContent = `${who==='user'?'You':'Bot'}: ${text}`;
      conversationDiv.appendChild(d);
      transcript.push({ who, text });
      conversationDiv.scrollTop = conversationDiv.scrollHeight;
    }

    // === PDF EXPORT ===
    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const name = document.getElementById('studentName').value || 'Student';
      const date = document.getElementById('sessionDate').value
                    || new Date().toLocaleDateString();
      doc.setTextColor(0,0,0);
      doc.text(`Conversation Transcript\nName: ${name}\nDate: ${date}`, 10, 10);
      let y = 30;
      transcript.forEach(entry => {
        let lbl = entry.who==='bot'?'Bot'
                : entry.who==='user'?'You'
                : entry.who.charAt(0).toUpperCase()+entry.who.slice(1);
        if (entry.who==='user')       doc.setTextColor(0,150,0);
        else if (entry.who==='correction') doc.setTextColor(0,0,200);
        else if (entry.who==='tip')       doc.setTextColor(184,92,0);
        else                             doc.setTextColor(0,0,0);
        const lines = doc.splitTextToSize(`${lbl}: ${entry.text}`, 180);
        lines.forEach(line => {
          doc.text(line, 10, y);
          y+=10; if (y>280){ doc.addPage(); y=20; }
        });
      });
      const fn = `${name.replace(/\s+/g,'_')}_${date.replace(/\//g,'-')}_fastfood_cashier.pdf`;
      doc.save(fn);
    }; 

    
  </script>

<!-- Script sample at the bottom for reference -->
<div style="background-color: #f5f5f7; padding: 0 20px 20px 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; font-size: 16px;">
  <div id="chatContainer" style="width: 500px; margin: auto; background-color: #f8f8f8; border: 1px solid #ccc; border-radius: 20px; padding: 10px;">
    <div style="max-width: 70%; background-color: #e6e6e6; color: #000; padding: 10px; margin-bottom: 10px; border-radius: 15px; float: left; clear: both;">
      Hello! Welcome to Burger Place. May I take your order?
    </div>
    <div style="max-width: 70%; background-color: #007aff; color: #fff; padding: 10px; margin-bottom: 10px; border-radius: 15px; float: right; clear: both;">
      Yes, I‚Äôd like a cheeseburger, please.
    </div>
    <div style="max-width: 70%; background-color: #e6e6e6; color: #000; padding: 10px; margin-bottom: 10px; border-radius: 15px; float: left; clear: both;">
      Would you like fries or a drink with that?
    </div>
    <div style="max-width: 70%; background-color: #007aff; color: #fff; padding: 10px; margin-bottom: 10px; border-radius: 15px; float: right; clear: both;">
      Just fries, thank you.
    </div>
    <div style="max-width: 70%; background-color: #e6e6e6; color: #000; padding: 10px; margin-bottom: 10px; border-radius: 15px; float: left; clear: both;">
      Is that for here or to go?
    </div>
    <div style="max-width: 70%; background-color: #007aff; color: #fff; padding: 10px; margin-bottom: 10px; border-radius: 15px; float: right; clear: both;">
      To go, please.
    </div>
    <div style="max-width: 70%; background-color: #e6e6e6; color: #000; padding: 10px; margin-bottom: 10px; border-radius: 15px; float: left; clear: both;">
      Can I have your name for the order, please?
    </div>
    <div style="max-width: 70%; background-color: #007aff; color: #fff; padding: 10px; margin-bottom: 10px; border-radius: 15px; float: right; clear: both;">
      My name is _______.
    </div>
    <div style="max-width: 70%; background-color: #e6e6e6; color: #000; padding: 10px; margin-bottom: 10px; border-radius: 15px; float: left; clear: both;">
      Your total is $7.50 How would you like to pay?
    </div>
    <div style="max-width: 70%; background-color: #007aff; color: #fff; padding: 10px; margin-bottom: 10px; border-radius: 15px; float: right; clear: both;">
      With my credit card.
    </div>
    <div style="max-width: 70%; background-color: #e6e6e6; color: #000; padding: 10px; margin-bottom: 10px; border-radius: 15px; float: left; clear: both;">
      Thank you! Please wait while we prepare your order.
    </div>
    <div style="max-width: 70%; background-color: #007aff; color: #fff; padding: 10px; margin-bottom: 10px; border-radius: 15px; float: right; clear: both;">
      Thank you!
    </div>
    <div style="clear: both;"></div>
  </div>
  <div style="text-align: right; margin-top: 10px;">
    <button onclick="toggleChat()" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 5px 10px; font-size: 12px; cursor: pointer; border-radius: 5px;">
      show | hide script
    </button>
  </div>
  <script>
    function toggleChat() {
      const chatContainer = document.getElementById("chatContainer");
      chatContainer.style.display = chatContainer.style.display === "none" ? "block" : "none";
    }
  </script>
</div>
</body>
</html>
