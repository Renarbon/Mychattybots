<!-- Only the <script> section is shown for brevity; keep all other HTML the same -->
<script>
(function() {
    let participants = {};
    let teacherRecord = null;
    let teacherDays = 0;
    let teacherDates = new Set();
    let allSessionDates = new Set();
    let allNamesSet = new Set();
    let teacherNameChosen = '';
    let teacherEmailChosen = '';

    // ... all element selectors as before

    processBtn.addEventListener('click', handleFiles);
    downloadCsvBtn.addEventListener('click', downloadCsv);
    downloadPdfBtn.addEventListener('click', downloadPdf);
    generateReportBtn.addEventListener('click', finalizeResults);

    function handleFiles() {
        // Reset state
        participants = {};
        teacherRecord = null;
        teacherDays = 0;
        teacherDates = new Set();
        allSessionDates = new Set();
        allNamesSet = new Set();
        teacherNameChosen = '';
        teacherEmailChosen = '';

        const files = fileInput.files;
        if (!files || files.length === 0) {
            alert('Please select one or more CSV files.');
            return;
        }

        const filePromises = [];
        for (let i = 0; i < files.length; i++) {
            filePromises.push(parseFile(files[i]));
        }

        Promise.all(filePromises).then(() => {
            // After parsing, filter session dates to weekdays only
            allSessionDates = new Set(Array.from(allSessionDates).filter(isWeekday));
            // Also filter each participant's daysPresentSet
            for (const key in participants) {
                participants[key].daysPresentSet = new Set(Array.from(participants[key].daysPresentSet).filter(isWeekday));
            }
            populateTeacherDropdown();
        }).catch((err) => {
            console.error(err);
            alert('An error occurred while processing the files.');
        });
    }

    function isWeekday(dateStr) {
        // dateStr: "YYYY-MM-DD"
        const d = new Date(dateStr);
        const day = d.getDay(); // 0 = Sunday, 6 = Saturday
        return day >= 1 && day <= 5;
    }

    function populateTeacherDropdown() {
        teacherSelect.innerHTML = '';
        const namesArr = Array.from(allNamesSet).sort((a, b) => a.localeCompare(b));
        namesArr.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            teacherSelect.appendChild(option);
        });
        teacherSelectContainer.classList.remove('hidden');
    }

    function parseFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const csvText = e.target.result;
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        processRows(results.data);
                        resolve();
                    },
                    error: function(err) {
                        reject(err);
                    }
                });
            };
            reader.onerror = function(err) {
                reject(err);
            };
            reader.readAsText(file);
        });
    }

    // NEW: Extracts session date from "Join Time" column inside each row
    function getDateFromJoinTime(joinTime) {
        if (!joinTime) return null;
        // Try parsing strings like "2025-10-07 07:55:33" or "10/7/2025 07:55:33"
        let d = new Date(joinTime);
        if (isNaN(d)) {
            // Try parsing as MM/DD/YYYY
            const match = joinTime.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
            if (match) {
                return `${match[3]}-${match[1].padStart(2,'0')}-${match[2].padStart(2,'0')}`;
            }
            return null;
        }
        // Always output as YYYY-MM-DD
        return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
    }

    function processRows(rows) {
        rows.forEach(row => {
            const normalizedRow = {};
            for (const key in row) {
                if (!row.hasOwnProperty(key)) continue;
                const cleanedKey = key.replace(/^\uFEFF/, '');
                const lower = cleanedKey.trim().toLowerCase();
                normalizedRow[lower] = row[key];
            }
            const name = (normalizedRow['name (original name)'] || normalizedRow['name'] || '').trim();
            const email = (normalizedRow['email'] || normalizedRow['user email'] || '').trim();
            const duration = parseFloat(normalizedRow['duration (minutes)'] || normalizedRow['duration'] || normalizedRow['duration(minutes)'] || 0) || 0;
            const joinTime = (normalizedRow['join time'] || normalizedRow['first join time'] || '').trim();
            const leaveTime = (normalizedRow['leave time'] || normalizedRow['last leave time'] || '').trim();

            if (!name && !email) {
                return;
            }

            // Get session date from joinTime
            const sessionDate = getDateFromJoinTime(joinTime);
            if (!sessionDate) return; // skip if can't parse date

            allSessionDates.add(sessionDate);

            // Collect name for dropdown
            if (name) allNamesSet.add(name);

            // Use name as key (case-insensitive)
            const key = name.toLowerCase();
            if (!participants[key]) {
                participants[key] = {
                    name: name || '(No Name)',
                    email: email,
                    totalMinutes: 0,
                    daysPresentSet: new Set(),
                    firstJoin: null,
                    lastLeave: null
                };
            }
            const participant = participants[key];
            participant.totalMinutes += duration;
            participant.daysPresentSet.add(sessionDate);
            participant.firstJoin = earliestTime(participant.firstJoin, joinTime);
            participant.lastLeave = latestTime(participant.lastLeave, leaveTime);
        });
    }

    // ... rest of code unchanged (finalizeResults, escapeHtml, downloadCsv, downloadPdf)
})();
</script>
