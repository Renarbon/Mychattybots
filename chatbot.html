<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ESL ChattyBot (Lemonfox Voice, Grammar, PDF)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 30px auto; background: #f9f9fc; }
    #chat { background: #fff; border-radius: 10px; padding: 18px; min-height: 260px; margin-bottom: 16px; box-shadow: 0 2px 10px #2221; }
    .bot { color: #1976d2; margin: 8px 0; }
    .user { color: #333; margin: 8px 0; text-align: right; }
    .correction { color: #2e7d32; font-style: italic; font-size: 0.96em; }
    #input-area { display: flex; gap: 7px; }
    #student-name { padding: 7px; margin-bottom: 8px; border-radius: 5px; border: 1px solid #bbb; }
    #user-input { flex: 1; padding: 8px; display: none; }
    button { padding: 8px 14px; border-radius: 6px; border: none; background: #1976d2; color: #fff; cursor: pointer; }
    button:disabled { background: #aaa; }
    #status { margin: 8px 0; color: #999; }
    #download-pdf { margin: 12px 0; background: #4caf50; }
  </style>
</head>
<body>
  <h2>ESL ChattyBot</h2>
  <input id="student-name" placeholder="Enter your name and press Enter..." />
  <div id="chat"></div>
  <div id="status"></div>
  <div id="input-area">
    <input id="user-input" style="display:none;" autocomplete="off" disabled />
    <button id="send-btn" style="display:none;">Send</button>
    <button id="mic-btn">ðŸŽ¤ Speak</button>
  </div>
  <button id="download-pdf" style="display:none;">Download PDF</button>
  <script>
    const GRAMMAR_API_URL = "https://chattybot-backend.onrender.com/api/grammar-correct";
    const CHATBOT_API_URL = "https://chattybot-backend.onrender.com/api/chatbot";
    const MAX_QUESTIONS = 6;

    // Lemonfox Adam voice function
    async function lemonfoxSpeak(text) {
  const apiKey = "pqT589X7JBTimS2MVoP1IyNOPD1iVwGX";
  try {
    const response = await fetch("https://api.lemonfox.ai/tts", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-api-key": apiKey
      },
      body: JSON.stringify({
        text: text,
        voice: "Adam"
      })
    });
    const data = await response.json();
    if (data.audioUrl) {
      const audio = new Audio(data.audioUrl);
      audio.play();
    }
    // If there's no audioUrl or Lemonfox fails, do nothing (no browser TTS)
  } catch (e) {
    // Do nothing if Lemonfox fails
  }
}

          // fallback: use browser TTS if Lemonfox fails
          if ('speechSynthesis' in window) {
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'en-US';
            speechSynthesis.cancel();
            speechSynthesis.speak(utter);
          }
        }
      } catch (e) {
        // fallback to browser TTS
        if ('speechSynthesis' in window) {
          const utter = new SpeechSynthesisUtterance(text);
          utter.lang = 'en-US';
          speechSynthesis.cancel();
          speechSynthesis.speak(utter);
        }
      }
    }

    let studentName = '';
    let questionCount = 0;
    let conversation = [
      { role: "system", content: "You are a friendly English tutor for ESL students. Ask a question about daily life, hobbies, travel, or food. Wait for the student's answer, then reply naturally. After 6 exchanges, say 'Great job! Conversation finished.' and do not ask any more questions." }
    ];
    let transcript = [];
    let finished = false;

    const chat = document.getElementById('chat');
    const input = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const micBtn = document.getElementById('mic-btn');
    const status = document.getElementById('status');
    const pdfBtn = document.getElementById('download-pdf');
    const nameInput = document.getElementById('student-name');

    nameInput.addEventListener('keyup', function(e) {
      if (e.key === 'Enter' && nameInput.value.trim()) {
        studentName = nameInput.value.trim();
        nameInput.disabled = true;
        micBtn.disabled = false;
        startBot();
      }
    });

    function startBot() {
      addMessage('bot', "Hello " + studentName + "! Let's practice English. I'll ask you some questions. Are you ready?");
      lemonfoxSpeak("Hello " + studentName + "! Let's practice English. I'll ask you some questions. Are you ready?");
    }

    function addMessage(role, text, subtext = "") {
      const msg = document.createElement('div');
      msg.className = role;
      msg.textContent = text;
      chat.appendChild(msg);
      if (subtext) {
        const sub = document.createElement('div');
        sub.className = 'correction';
        sub.textContent = subtext;
        chat.appendChild(sub);
      }
      chat.scrollTop = chat.scrollHeight;
    }

    // ---- Speech Recognition ----
    let recognition;
    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition();
      recognition.continuous = false;
      recognition.lang = 'en-US';

      recognition.onresult = async function(event) {
        if (finished) return;
        const transcriptText = event.results[0][0].transcript;
        addMessage('user', transcriptText);

        status.textContent = "Checking grammar...";

        // --- Grammar Correction ---
        let corrected = transcriptText;
        let correctionShown = false;
        try {
          const res = await fetch(GRAMMAR_API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: transcriptText })
          });
          const data = await res.json();
          if (data && data.corrected && data.corrected !== transcriptText) {
            corrected = data.corrected;
            addMessage('user', "(Corrected: " + corrected + ")", "");
            correctionShown = true;
          }
        } catch (e) {
          // fallback: use original
        }

        conversation.push({ role: "user", content: corrected });
        status.textContent = "Bot is thinking...";

        // --- Bot Reply ---
        let botReply = await getOpenAIResponse();
        addMessage('bot', botReply);
        lemonfoxSpeak(botReply);

        transcript.push({
          question: conversation[conversation.length-2]?.content || "",
          studentAnswer: transcriptText,
          correctedAnswer: corrected,
          botReply: botReply
        });

        questionCount++;
        if (questionCount >= MAX_QUESTIONS) {
          // End conversation, do NOT ask a new question
          finished = true;
          input.disabled = true;
          sendBtn.disabled = true;
          micBtn.disabled = true;
          status.textContent = "Conversation finished. Download your PDF for submission.";
          // Final message
          setTimeout(() => {
            addMessage('bot', "Great job! Conversation finished.");
            lemonfoxSpeak("Great job! Conversation finished.");
            pdfBtn.style.display = '';
          }, 600);
        } else {
          status.textContent = "";
        }
      };
      recognition.onerror = function(e) {
        micBtn.disabled = false;
        status.textContent = "Could not recognize speech. Try again.";
      };
      recognition.onstart = function() {
        micBtn.disabled = true;
        status.textContent = "Listening...";
      };
      recognition.onend = function() {
        micBtn.disabled = false;
        status.textContent = "";
      };
    }

    micBtn.onclick = () => {
      if (finished) return;
      if (recognition) recognition.start();
    };

    // --- Chatbot via Backend ---
    async function getOpenAIResponse() {
      try {
        const response = await fetch(CHATBOT_API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "gpt-4o",
            messages: conversation
          })
        });
        const data = await response.json();
        const botMsg = data.reply?.trim() || "Sorry, I didn't get that.";
        conversation.push({ role: "assistant", content: botMsg });
        return botMsg;
      } catch (e) {
        return "Sorry, I couldn't connect to the server.";
      }
    }

    // --- PDF Download ---
    pdfBtn.onclick = () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text("ESL Conversation Practice", 10, 12);
      doc.text(`Student: ${studentName}`, 10, 20);

      let y = 32;
      const pageWidth = doc.internal.pageSize.getWidth();
      const margin = 10;
      const maxLineWidth = pageWidth - 2 * margin;

      function printParagraph(label, text, color = [33, 33, 33]) {
        doc.setTextColor(...color);
        let lines = doc.splitTextToSize(`${label} ${text}`, maxLineWidth);
        lines.forEach(line => {
          doc.text(line, margin + 2, y);
          y += 6;
        });
      }

      transcript.forEach((entry, i) => {
        doc.setFont(undefined, "bold");
        printParagraph(`Q${i + 1}:`, entry.question);

        doc.setFont(undefined, "normal");

        if (entry.studentAnswer !== entry.correctedAnswer) {
          printParagraph("Your answer:", entry.studentAnswer, [229, 57, 53]);
          printParagraph("Corrected:", entry.correctedAnswer, [46, 125, 50]);
        } else {
          printParagraph("Your answer:", entry.studentAnswer, [46, 125, 50]);
        }

        printParagraph("Bot:", entry.botReply);

        y += 2;
        if (y > 270) { doc.addPage(); y = 18; }
      });

      const fileName = `${studentName.replace(/[^a-z0-9]/gi, '_')}_ESL_ChattyBot.pdf`;
      doc.save(fileName);
    };

    // Initial state: disable mic and chat until student name is entered
    micBtn.disabled = true;
  </script>
</body>
</html>
