<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ESL Job Interview Practice</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #chat { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; margin-bottom: 10px; }
    .bot { color: blue; margin: 5px 0; }
    .student { color: green; margin: 5px 0; }
    button { margin-right: 5px; padding: 5px 10px; }
  </style>
</head>
<body>
  <h2>ESL Job Interview Practice</h2>

  <label for="voice-select">Choose a voice:</label>
  <select id="voice-select"></select>
  <br><br>

  <div id="chat"></div>

  <button id="speak-btn">🎤 Speak</button>
  <button id="pdf-btn" style="display:none;">📄 Download PDF</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const chat = document.getElementById("chat");
    const speakBtn = document.getElementById("speak-btn");
    const pdfBtn = document.getElementById("pdf-btn");
    const voiceSelect = document.getElementById("voice-select");

    let recognition;
    let listening = false;
    let voices = [];
    let currentQuestion = 0;
    const transcript = [];
    const questions = [
      "Can you tell me a little about yourself?",
      "Why are you interested in this job?",
      "What are your strengths and weaknesses?",
      "Can you describe a challenge you faced and how you handled it?",
      "Where do you see yourself in five years?",
      "Do you have any questions for us?"
    ];

    // ✅ Voice setup (Google voices first, only English)
    function loadVoices() {
      voices = speechSynthesis.getVoices()
        .filter(v => v.lang.toLowerCase().startsWith("en"));

      voices.sort((a, b) => {
        const aGoogle = a.name.toLowerCase().includes("google");
        const bGoogle = b.name.toLowerCase().includes("google");
        if (aGoogle && !bGoogle) return -1;
        if (!aGoogle && bGoogle) return 1;
        return a.name.localeCompare(b.name);
      });

      voiceSelect.innerHTML = "";
      voices.forEach((v, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = `${v.name} (${v.lang})`;
        voiceSelect.appendChild(opt);
      });

      let defaultIndex = voices.findIndex(v => v.name.includes("Google US English"));
      if (defaultIndex === -1) defaultIndex = 0;
      voiceSelect.value = defaultIndex;
    }
    speechSynthesis.onvoiceschanged = loadVoices;

    function speakWithBrowser(text) {
      if (!voices.length) loadVoices();
      const utterance = new SpeechSynthesisUtterance(text);
      const selectedIndex = voiceSelect.value;
      if (voices[selectedIndex]) utterance.voice = voices[selectedIndex];
      speechSynthesis.speak(utterance);
    }

    // ✅ Chat functions
    function addMessage(sender, text) {
      const div = document.createElement("div");
      div.className = sender;
      div.textContent = (sender === "bot" ? "Bot: " : "You: ") + text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      transcript.push(div.textContent);
    }

    function askQuestion() {
      if (currentQuestion < questions.length) {
        const q = questions[currentQuestion];
        addMessage("bot", q);
        speakWithBrowser(q);
      } else {
        addMessage("bot", "Great job! The interview is finished.");
        speakWithBrowser("Great job! The interview is finished.");
        pdfBtn.style.display = "inline-block";
      }
    }

    // ✅ Speech Recognition
    if ("webkitSpeechRecognition" in window) {
      recognition = new webkitSpeechRecognition();
      recognition.lang = "en-US";
      recognition.interimResults = false;
      recognition.continuous = false;

      recognition.onresult = function(event) {
        const text = event.results[0][0].transcript;
        addMessage("student", text);
        currentQuestion++;
        askQuestion();
      };

      recognition.onend = function() {
        if (listening) recognition.start();
      };
    } else {
      alert("Speech recognition not supported in this browser.");
    }

    // ✅ Button events
    speakBtn.addEventListener("click", () => {
      if (!listening) {
        recognition.start();
        listening = true;
        speakBtn.textContent = "⏹ Stop";
      } else {
        recognition.stop();
        listening = false;
        speakBtn.textContent = "🎤 Speak";
      }
    });

    pdfBtn.addEventListener("click", () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      transcript.forEach(line => {
        doc.text(line, 10, y);
        y += 10;
        if (y > 280) { doc.addPage(); y = 10; }
      });
      doc.save("interview_practice.pdf");
    });

    // ✅ Start interview
    window.onload = () => {
      loadVoices();
      askQuestion();
    };
  </script>
</body>
</html>
