<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ESL Job Interview Bot</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 650px; margin: 30px auto; background: #f9f9fc; }
    #chat { background: #fff; border-radius: 10px; padding: 18px; min-height: 260px; margin-bottom: 16px; box-shadow: 0 2px 10px #2221; }
    .bot { color: #1976d2; margin: 8px 0; }
    .user { color: #333; margin: 8px 0; text-align: right; }
    #student-name { padding: 7px; margin-bottom: 8px; border-radius: 5px; border: 1px solid #bbb; }
    #voice-select { margin-left: 10px; }
    #input-area { display: flex; gap: 7px; }
    #user-input { flex: 1; padding: 8px; display: none; }
    button { padding: 8px 14px; border-radius: 6px; border: none; background: #1976d2; color: #fff; cursor: pointer; }
    button:disabled { background: #aaa; }
    #status { margin: 8px 0; color: #999; }
    #download-pdf { margin: 12px 0; background: #4caf50; }
  </style>
</head>
<body>
  <h2>ESL ChattyBot - Job Interview Practice (6 Questions)</h2>
  <input id="student-name" placeholder="Enter your name and press Enter..." />
  <label for="voice-select"><b>Voice:</b></label>
  <select id="voice-select"></select>
  <div id="chat"></div>
  <div id="status"></div>
  <div id="input-area">
    <button id="mic-btn" disabled>ðŸŽ¤ Speak</button>
  </div>
  <button id="download-pdf" style="display:none;">Download PDF</button>

  <script>
    const GRAMMAR_API_URL = "https://chattybot-backend.onrender.com/api/grammar-correct";

    let studentName = '';
    let currentQuestion = 0;
    let finished = false;

    const questions = [
      "Can you tell me a little about yourself?",
      "Why do you want to work for our company?",
      "What are your main strengths?",
      "Can you describe a challenge you faced at work and how you solved it?",
      "How do you usually work in a team?",
      "Where do you see yourself in five years?"
    ];

    let transcript = [];

    const chat = document.getElementById('chat');
    const status = document.getElementById('status');
    const pdfBtn = document.getElementById('download-pdf');
    const nameInput = document.getElementById('student-name');
    const micBtn = document.getElementById('mic-btn');
    const voiceSelect = document.getElementById('voice-select');

    // ---- Browser Voices ----
    let voices = [];
    function loadVoices() {
      voices = speechSynthesis.getVoices();
      voiceSelect.innerHTML = "";
      voices.forEach((v, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = `${v.name} (${v.lang})`;
        voiceSelect.appendChild(opt);
      });
      // Pick Google US English if available
      let defaultIndex = voices.findIndex(v => v.lang === "en-US" && v.name.includes("Google"));
      if (defaultIndex === -1) defaultIndex = voices.findIndex(v => v.lang.startsWith("en"));
      if (defaultIndex !== -1) voiceSelect.value = defaultIndex;
    }
    window.speechSynthesis.onvoiceschanged = loadVoices;

    function speakWithBrowser(text) {
      if (!voices.length) loadVoices();
      const utterance = new SpeechSynthesisUtterance(text);
      const selectedIndex = voiceSelect.value;
      if (voices[selectedIndex]) utterance.voice = voices[selectedIndex];
      speechSynthesis.speak(utterance);
    }

    function addMessage(role, text) {
      const msg = document.createElement('div');
      msg.className = role;
      msg.textContent = text;
      chat.appendChild(msg);
      chat.scrollTop = chat.scrollHeight;
    }

    function askNextQuestion() {
      if (currentQuestion < questions.length) {
        const q = questions[currentQuestion];
        addMessage('bot', q);
        speakWithBrowser(q);
      } else {
        finished = true;
        const closing = "Thank you for answering my questions. You did a great job!";
        addMessage('bot', closing);
        speakWithBrowser(closing);
        status.textContent = "Conversation finished. Download your PDF.";
        pdfBtn.style.display = '';
      }
    }

    // ---- Name input ----
    nameInput.addEventListener('keyup', function(e) {
      if (e.key === 'Enter' && nameInput.value.trim()) {
        studentName = nameInput.value.trim();
        nameInput.disabled = true;
        micBtn.disabled = false;
        addMessage('bot', `Hello ${studentName}, welcome to your job interview simulation.`);
        speakWithBrowser(`Hello ${studentName}, welcome to your job interview simulation.`);
        setTimeout(askNextQuestion, 2500);
      }
    });

    // ---- Speech Recognition with toggle ----
    let recognition;
    let recognizing = false;

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRec();
      recognition.continuous = true;
      recognition.interimResults = false;
      recognition.la
