<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ESL ChattyBot with Voice</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 30px auto; background: #f9f9fc; }
    #chat { background: #fff; border-radius: 10px; padding: 18px; min-height: 260px; margin-bottom: 16px; box-shadow: 0 2px 10px #2221; }
    .bot { color: #1976d2; margin: 8px 0; }
    .user { color: #333; margin: 8px 0; text-align: right; }
    #input-area { display: flex; gap: 7px; }
    #student-name { padding: 7px; margin-bottom: 8px; border-radius: 5px; border: 1px solid #bbb; }
    #voice-select { margin-left: 10px; }
    #user-input { flex: 1; padding: 8px; }
    button { padding: 8px 14px; border-radius: 6px; border: none; background: #1976d2; color: #fff; cursor: pointer; }
    button:disabled { background: #aaa; }
    #status { margin: 8px 0; color: #999; }
    #download-pdf { margin: 12px 0; background: #4caf50; }
  </style>
</head>
<body>
  <h2>ESL ChattyBot with Voice</h2>
  <input id="student-name" placeholder="Enter your name and press Enter...">
  <label for="voice-select"><b>Voice:</b></label>
  <select id="voice-select"></select>
  <div id="chat"></div>
  <div id="status"></div>
  <div id="input-area">
    <input id="user-input" autocomplete="off">
    <button id="send-btn">Send</button>
  </div>
  <button id="download-pdf" style="display:none;">Download Transcript</button>

  <script>
    const CHATBOT_API_URL = "https://api.openai.com/v1/chat/completions";
    const API_KEY = "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";
    const MAX_QUESTIONS = 7;

    let studentName = '';
    let questionCount = 0;
    let finished = false;

    let conversation = [
      { role: "system", content: "you are a horny woman looking for sex" }
    ];
    let transcript = [];

    const chat = document.getElementById('chat');
    const status = document.getElementById('status');
    const pdfBtn = document.getElementById('download-pdf');
    const nameInput = document.getElementById('student-name');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const voiceSelect = document.getElementById('voice-select');

    let voices = [];
    function loadVoices() {
      voices = speechSynthesis.getVoices();
      voiceSelect.innerHTML = "";
      voices.forEach((v, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = `${v.name} (${v.lang})`;
        voiceSelect.appendChild(opt);
      });

      const defaultIndex = voices.findIndex(v => v.lang.startsWith("en"));
      if (defaultIndex !== -1) voiceSelect.value = defaultIndex;
    }
    window.speechSynthesis.onvoiceschanged = loadVoices;

    function speakText(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      const selectedIndex = voiceSelect.value;
      if (voices[selectedIndex]) utterance.voice = voices[selectedIndex];
      speechSynthesis.speak(utterance);
    }

    function addMessage(role, text) {
      const msg = document.createElement('div');
      msg.className = role;
      msg.textContent = text;
      chat.appendChild(msg);
      chat.scrollTop = chat.scrollHeight;
    }

    async function fetchChatbotResponse() {
      try {
        const response = await fetch(CHATBOT_API_URL, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${API_KEY}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: "gpt-4",
            messages: conversation,
          }),
        });
        const data = await response.json();
        return data.choices[0]?.message?.content?.trim() || "No response from bot.";
      } catch (error) {
        console.error("Error contacting API:", error);
        return "Failed to connect to the chatbot API.";
      }
    }

    nameInput.addEventListener('keyup', function (e) {
      if (e.key === 'Enter' && nameInput.value.trim()) {
        studentName = nameInput.value.trim();
        nameInput.disabled = true;
        status.textContent = `Welcome, ${studentName}! Start the conversation below.`;
        const greeting = `Hello ${studentName}! Let's practice English.`;
        addMessage('bot', greeting);
        speakText(greeting);
        conversation.push({ role: "assistant", content: greeting });
      }
    });

    sendBtn.onclick = async () => {
      if (!userInput.value.trim() || finished) return;

      const userMessage = userInput.value.trim();
      addMessage('user', userMessage);
      conversation.push({ role: "user", content: userMessage });

      userInput.value = '';
      questionCount++;

      if (questionCount >= MAX_QUESTIONS) {
        finished = true;
        const closingMessage = "Great job! You've completed the practice.";
        addMessage('bot', closingMessage);
        speakText(closingMessage);
        status.textContent = "Conversation finished. Download your transcript below.";
        pdfBtn.style.display = '';
        transcript.push({ question: conversation.slice(-2)[0]?.content || "", answer: userMessage });
        return;
      }

      const botResponse = await fetchChatbotResponse();
      addMessage('bot', botResponse);
      speakText(botResponse);

      transcript.push({ question: conversation.slice(-2)[0]?.content || "", answer: userMessage });
    };

    pdfBtn.onclick = async () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("ESL Conversation Transcript", 10, 10);
      doc.text(`Student: ${studentName}`, 10, 20);

      let y = 30;
      transcript.forEach(({ question, answer }, idx) => {
        doc.text(`Q${idx + 1}: ${question}`, 10, y);
        y += 10;
        doc.text(`A${idx + 1}: ${answer}`, 10, y);
        y += 10;
      });

      doc.save(`${studentName.replace(/\\W/g, '_')}_conversation.pdf`);
    };
  </script>
</body>
</html>
