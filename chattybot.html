<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ESL ChattyBot ‚Äì Practice Role Play</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f2f2f2; }
    #chat { background: white; padding: 20px; max-width: 700px; margin: auto; border-radius: 10px; }
    .message { margin: 10px 0; }
    .user { color: green; }
    .bot { color: blue; }
    input, button { padding: 10px; margin: 5px; }
    input[readonly] { background-color: #eee; }
  </style>
</head>
<body>
  <div id="chat">
    <h2>üé§ ESL ChattyBot</h2>
    <label>Student Name: <input id="studentName" type="text" /></label><br>
    <label>Date: <input id="sessionDate" type="date" /></label><br>
    <div id="conversation"></div>
    <button onclick="startRecording()">üéôÔ∏è Record Your Answer</button>
    <button onclick="downloadPDF()">‚¨áÔ∏è Download PDF</button>
  </div>
<div style="background-color: #f5f5f7; padding: 0 20px 20px 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; font-size: 16px;">
  <!-- Chat container mimicking an iPhone screen -->
  <div id="chatContainer" style="width: 500px; margin: auto; background-color: #f8f8f8; border: 1px solid #ccc; border-radius: 20px; padding: 10px;">
    
    <!-- Chattybot message aligned left -->
    <div style="max-width: 70%; background-color: #e6e6e6; color: #000; padding: 10px; margin-bottom: 10px; border-radius: 15px; float: left; clear: both;">
    Excuse me. Can I borrow your pen?
    </div>
    
    		<!-- Student message aligned right -->
    		<div style="max-width: 70%; background-color: #007aff; color: #fff; padding: 10px; margin-bottom: 10px; border-radius: 15px; float: right; clear: both;">
      		Sure, here you go.
    		</div>
    
    <!-- Chattybot message aligned left -->
    <div style="max-width: 70%; background-color: #e6e6e6; color: #000; padding: 10px; margin-bottom: 10px; border-radius: 15px; float: left; clear: both;">
    I need to go to the restroom,would you mind taking a look at my things for a moment?
    </div>
    
    		
<!-- Student message aligned right -->
    		<div style="max-width: 70%; background-color: #007aff; color: #fff; padding: 10px; margin-bottom: 10px; border-radius: 15px; float: right; clear: both;">
      		No problem, I‚Äôll take care of them.
    		</div>

<!-- Chattybot message aligned left -->
    <div style="max-width: 70%; background-color: #e6e6e6; color: #000; padding: 10px; margin-bottom: 10px; border-radius: 15px; float: left; clear: both;">
    Thanks, if it hadn‚Äôt been for you, I wouldn‚Äôt have been able to go to the restroom.
    </div>

<!-- Student message aligned right -->
    		<div style="max-width: 70%; background-color: #007aff; color: #fff; padding: 10px; margin-bottom: 10px; border-radius: 15px; float: right; clear: both;">
      		Glad to help, don‚Äôt be afraid to ask.
    		</div>


    		
    <!-- Chattybot message aligned left -->
    <div style="max-width: 70%; background-color: #e6e6e6; color: #000; padding: 10px; margin-bottom: 10px; border-radius: 15px; float: left; clear: both;">
    oh, the announcer is calling us, are you taking the same plane?.
    </div>
    
            <!-- Student message aligned right -->
    		<div style="max-width: 70%; background-color: #007aff; color: #fff; padding: 10px; margin-bottom: 10px; border-radius: 15px; float: right; clear: both;">
      		No, my plane leaves in an hour, have a nice flight.
    		</div>
    		
 

  <!-- This is the javascript for the Show | Hide button -->
  <div style="clear: both;"></div>
  </div>

  <script>
    function toggleChat() {
      var chatContainer = document.getElementById("chatContainer");
      if (chatContainer.style.display === "none") {
        chatContainer.style.display = "block";
      } else {
        chatContainer.style.display = "none";
      }
    }
  </script>

  <!-- Toggle Button placed to the right below the script -->
  <div style="text-align: right; margin-top: 10px;">
    <button onclick="toggleChat()" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 5px 10px; font-size: 12px; cursor: pointer; border-radius: 5px;">
      show | hide script
    </button>
  </div>

</div>

  <script>
    const transcript = [];
    const conversationDiv = document.getElementById('conversation');

    const scriptLines = [
      "Excuse me. Can I borrow your pen?",
      "I need to go to the restroom, would you mind taking a look at my things for a moment?",
      "Thanks, if it hadn‚Äôt been for you, I wouldn‚Äôt have been able to go to the restroom.",
      "Oh, the announcer is calling us, are you taking the same plane?",
      "Take a look at the script. If it doesn‚Äôt match your answers correctly, say 'yes' and we‚Äôll do it again. Would you like to practice again?"
    ];

    let currentLine = 0;
    let hasPromptedStart = false;

    // Voice selection
    let selectedVoice;
    window.speechSynthesis.onvoiceschanged = () => {
      const voices = speechSynthesis.getVoices();
      selectedVoice = voices.find(v =>
        v.name.includes("Google US English") ||
        v.name.includes("Microsoft Zira") ||
        v.name.toLowerCase().includes("english")
      );
    };

    function speak(text) {
      const msg = new SpeechSynthesisUtterance(text);
      if (selectedVoice) msg.voice = selectedVoice;
      speechSynthesis.speak(msg);
    }

    function startRecording() {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      if (!hasPromptedStart) {
        speak("Are you ready to practice?");
        hasPromptedStart = true;
      } else {
        recognition.start();
      }

      recognition.onresult = function(event) {
        const userText = event.results[0][0].transcript;
        addMessage('user', userText);

        // Bot advances to next line
        if (currentLine < scriptLines.length) {
          const botReply = scriptLines[currentLine++];
          addMessage('bot', botReply);
          speak(botReply);
        } else {
          // After the last line, wait for yes/no
          const lower = userText.toLowerCase();
          if (lower.includes("yes")) {
            currentLine = 0;
            addMessage('bot', scriptLines[currentLine]);
            speak(scriptLines[currentLine++]);
          } else if (lower.includes("no")) {
            addMessage('bot', "Great work today! See you next time.");
            speak("Great work today! See you next time.");
          }
        }
      };

      recognition.onerror = function(event) {
        alert("Speech recognition error: " + event.error);
      };
    }

    function addMessage(who, text) {
      const div = document.createElement('div');
      div.className = `message ${who}`;
      div.textContent = `${who === 'user' ? 'You' : 'Bot'}: ${text}`;
      conversationDiv.appendChild(div);
      transcript.push({ who, text });
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const name = document.getElementById('studentName').value || 'Student';
      const date = document.getElementById('sessionDate').value || new Date().toLocaleDateString();
      doc.text(`Conversation Transcript
Name: ${name}
Date: ${date}`, 10, 10);

      let y = 30;
      transcript.forEach(entry => {
        doc.text(`${entry.who === 'bot' ? 'Bot' : 'Student'}: ${entry.text}`, 10, y);
        y += 10;
        if (y > 280) {
          doc.addPage();
          y = 20;
        }
      });
      doc.save("chattybot_conversation.pdf");
    }
  </script>
</body>
</html>
