<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ESL ChattyBot ‚Äì The Career Advisor (Student Role)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f2f2f2; }
    #chat { background: white; padding: 20px; max-width: 700px; margin: auto; border-radius: 10px; }
    .message { margin: 10px 0; }
    .user { color: green; }
    .bot { color: #0b2e8a; }
    input, button { padding: 10px; margin: 5px; }
    input[readonly] { background-color: #eee; }
    #studentInput { width: 90%; padding: 8px; }
    #pdfBtn { margin-top: 10px; }
  </style>
</head>
<body>
  <div id="chat">
    <h2>üßë‚Äçüéì ESL ChattyBot ‚Äì The Career Advisor (Student reads the green lines)</h2>
    <label>Student Name: <input id="studentName" type="text" autocomplete="off" /></label>
    <button id="startBtn">Start</button>
    <span style="margin-left:15px; font-size:0.98em;">Date: <span id="sessionDate"></span></span>
    <br>
    <label for="voice-select"><b>Voice:</b></label>
    <select id="voice-select">
       <option value="adam">Adam</option>
    <option value="sarah">Sarah</option>
    <option value="emily">Emily</option>
    <option value="james">James</option>
    <option value="jenny">Jenny</option>
    <option value="nicole">Nicole</option>
    <option value="santa">Santa</option>
    </select>
    <div style="margin: 12px 0; color: #007aff; background: #e6e6ff; border-radius: 6px; padding: 8px; max-width: 600px;">
      <b>Instructions:</b> You are the <b>student</b> (read the green parts aloud each turn). The ChatBot will play the <b>career advisor</b>.
    </div>
    <div id="conversation"></div>
    <button onclick="startRecording()" id="recordButton" disabled>üéôÔ∏è Record</button>
    <button onclick="submitStudentResponse()" id="sendButton" disabled>üì® Send</button>
    <input type="text" id="studentInput" readonly />
    <button onclick="downloadPDF()" id="pdfBtn" disabled>‚¨áÔ∏è Download PDF</button>
  </div>
  <script>
    // === CONFIG: Backend for Lemonfox (change if needed) ===
    const BASE_URL = "https://chattybot-backend.onrender.com";
    const LEMONFOX_PROXY_URL = `${BASE_URL}/api/lemonfox-tts`;

    // === SCRIPT DATA ===
    // Bot (counselor) lines ‚Äì blue
    const botLines = [
      "So, Andy, what brings you here today?",
      "Hotel management. Correct me if I'm wrong, but weren't you studying marine biology?",
      "OK. So how can I help?",
      "Give me a day or two to look into it. I'll get back to you before the end of the week.",
      "My pleasure. And I'd be more than happy to write you a recommendation if you decide to apply."
    ];
    // Student (student) lines ‚Äì gray
    const scriptLines = [
      "I'd like some advice. I've been considering taking up hotel management.",
      "I was. But I've given it some thought, and I've decided I'm not cut out for science.",
      "Well, I'd like to enroll in a good program. I was hoping you could steer me in the right direction.",
      "That's great.",
    ];

    // === STATE ===
    let studentName = "";
    let currentLine = 0;
    let tempUserText = "";
    let awaitingUser = false;
    let conversationStarted = false;
    const transcript = [];
    const conversationDiv = document.getElementById('conversation');

    // Date auto-fill
    document.getElementById("sessionDate").textContent = new Date().toLocaleDateString();

    // --- Lemonfox via backend proxy ---
    async function speakWithLemonfox(text) {
      const voice = document.getElementById('voice-select').value;
      try {
        const response = await fetch(LEMONFOX_PROXY_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text, voice })
        });
        if (!response.ok) {
          alert("Lemonfox error: " + response.status + " - " + response.statusText);
          return;
        }
        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        const audio = new Audio(audioUrl);
        await audio.play();
      } catch (e) {
        alert("Lemonfox error: " + e);
      }
    }

    function addMessage(who, text) {
      const d = document.createElement('div');
      d.className = `message ${who}`;
      d.textContent = `${who==='user'?studentName||"You":"Bot"}: ${text}`;
      conversationDiv.appendChild(d);
      transcript.push({ who, text });
      conversationDiv.scrollTop = conversationDiv.scrollHeight;
    }

    // --- Start conversation after name is entered & start pressed/Enter
    document.getElementById("startBtn").onclick = startConversation;
    document.getElementById("studentName").addEventListener("keydown", function(e) {
      if (e.key === "Enter") startConversation();
    });

    function startConversation() {
      if (conversationStarted) return;
      studentName = document.getElementById("studentName").value.trim();
      if (!studentName) {
        alert("Please enter your name.");
        return;
      }
      document.getElementById("startBtn").disabled = true;
      document.getElementById("studentName").disabled = true;
      document.getElementById("recordButton").disabled = true;
      document.getElementById("sendButton").disabled = true;
      document.getElementById("pdfBtn").disabled = true;
      conversationDiv.innerHTML = "";
      transcript.length = 0;
      currentLine = 0;
      conversationStarted = true;

      // Bot starts
      let botFirstLine = botLines[0].replace("Andy", studentName);
      addMessage('bot', botFirstLine);
      speakWithLemonfox(botFirstLine).then(() => {
        showStudentPrompt();
      });
    }

    // Show the student prompt (gray line), enable Record
    function showStudentPrompt() {
      if (currentLine < scriptLines.length) {
        addMessage('user', scriptLines[currentLine]);
        document.getElementById("recordButton").disabled = false;
        awaitingUser = true;
      }
    }

    function startRecording() {
      const recog = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recog.lang = 'en-US'; recog.interimResults = false; recog.maxAlternatives = 1;
      recog.start();
      recog.onresult = e => {
        tempUserText = e.results[0][0].transcript;
        document.getElementById("studentInput").value = tempUserText;
        document.getElementById("sendButton").disabled = false;
      };
      recog.onerror = e => alert("Speech recognition error: " + e.error);
    }

    function submitStudentResponse() {
      if (!tempUserText || !awaitingUser) return;
      // Save what student actually said
      transcript.push({ who: "studentResponse", text: tempUserText });
      document.getElementById("studentInput").value = "";
      tempUserText = "";
      document.getElementById("sendButton").disabled = true;
      document.getElementById("recordButton").disabled = true;
      awaitingUser = false;

      // Bot speaks next
      if (currentLine + 1 < botLines.length) {
        setTimeout(() => {
          addMessage('bot', botLines[currentLine + 1].replace("Andy", studentName));
          speakWithLemonfox(botLines[currentLine + 1].replace("Andy", studentName)).then(() => {
            currentLine++;
            showStudentPrompt();
            if (currentLine >= scriptLines.length) {
              // Enable PDF at end
              document.getElementById("pdfBtn").disabled = false;
            }
          });
        }, 900);
      } else {
        // Conversation finished
        addMessage('bot', "Great job! Conversation finished.");
        document.getElementById("pdfBtn").disabled = false;
      }
    }

    document.getElementById("sendButton").onclick = submitStudentResponse;

    // --- PDF EXPORT ---
    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const name = studentName || 'Student';
      const date = document.getElementById('sessionDate').textContent;
      doc.setTextColor(0, 0, 0);
      doc.text(`Conversation Transcript\nName: ${name}\nDate: ${date}`, 10, 10);
      let y = 30;
      transcript.forEach(entry => {
        let whoLabel = entry.who === 'bot' ? 'Counselor' : entry.who === 'user' ? 'Student (prompt)' : 'Student (spoken)';
        doc.setTextColor(entry.who === 'bot' ? 11 : 0, entry.who === 'bot' ? 46 : 150, entry.who === 'bot' ? 138 : 0);
        const lines = doc.splitTextToSize(`${whoLabel}: ${entry.text}`, 180);
        lines.forEach(line => {
          doc.text(line, 10, y);
          y += 10;
          if (y > 280) { doc.addPage(); y = 20; }
        });
      });
      const filename = `${name.replace(/\s+/g, '_')}_${date.replace(/[\/]/g, '-')}_unit1.pdf`;
      doc.save(filename);
    }
    document.getElementById("pdfBtn").onclick = downloadPDF;

  </script>

  

</body>
</html>
