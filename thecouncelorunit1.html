<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ESL ChattyBot ‚Äì You are the one who backed into someone's car)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f2f2f2; }
    #chat { background: white; padding: 20px; max-width: 700px; margin: auto; border-radius: 10px; }
    .message { margin: 10px 0; }
    .user { color: #0b2e8a; }
    .bot { color: green; }
    input, button { padding: 10px; margin: 5px; }
    input[readonly] { background-color: #eee; }
    #studentInput { width: 90%; padding: 8px; }
    #pdfBtn { margin-top: 10px; }
  </style>
</head>
<body>
  <div id="chat">
    <h2>üßë‚Äçüíº ESL ChattyBot ‚Äì You are the one who caused the problem, you might need to wait 3‚Äì5 seconds for voices to load)</h2>
    <label>Your Name: <input id="studentName" type="text" autocomplete="off" /></label>
    <button id="startBtn">Start</button>
    <span style="margin-left:15px; font-size:0.98em;">Date: <span id="sessionDate"></span></span>
    <br>
    <label for="voice-select"><b>Student Voice:</b></label>
    <select id="voice-select"></select>
    <div style="margin: 12px 0; color: #007aff; background: #e6e6ff; border-radius: 6px; padding: 8px; max-width: 600px;">
      <b>Instructions:</b> <b>You</b> are <b>A</b> (read the blue parts aloud each turn). ChattyBot will play <b>B</b> with the selected voice.
    </div>
    <div id="conversation"></div>
    <button onclick="startRecording()" id="recordButton" disabled>üéôÔ∏è Record</button>
    <button onclick="submitUserResponse()" id="sendButton" disabled>üì® Send</button>
    <input type="text" id="studentInput" readonly />
    <button onclick="downloadPDF()" id="pdfBtn" disabled>‚¨áÔ∏è Download PDF</button>
  </div>
  <script>
    // === SCRIPT DATA ===
    const botLines = [
      "What happened?",
      "How bad is it?",
      "Look, these things happen. I'm sure we can work something out."
    ];
    const scriptLines = [
      "I'm really sorry, but I have some bad news.",
      "I'm afraid I just backed into your car while I was parking mine. It was totally my fault.",
      "Pretty bad. It's going to be expensive to fix. I'm so embarrassed.",
      "Well, I insist on paying for it. And please accept my apology. I feel awful about it."
    ];

    let userName = "";
    let botName = "";
    let currentLine = 0;
    let tempUserText = "";
    let awaitingUser = false;
    let conversationStarted = false;
    const transcript = [];
    const conversationDiv = document.getElementById('conversation');

    // --- Attempt tracking (local only) ---
    // Tracks attempts per student locally. The attempt number will be appended to the Date in the PDF.
    function attemptsStorageKey(name) {
      return `unit2comactivator_attempts_${name.replace(/\s+/g,'_').toLowerCase()}`;
    }
    function incrementAttempts(name) {
      const key = attemptsStorageKey(name);
      const current = parseInt(localStorage.getItem(key) || '0', 10);
      const next = current + 1;
      localStorage.setItem(key, String(next));
      return next;
    }
    function getAttempts(name) {
      const key = attemptsStorageKey(name);
      return parseInt(localStorage.getItem(key) || '0', 10);
    }
    let attemptCount = 0; // set when starting the conversation

    document.getElementById("sessionDate").textContent = new Date().toLocaleDateString();

    // === Load voices (Google English voices if available) ===
    function loadVoices() {
      const voices = speechSynthesis.getVoices();
      const select = document.getElementById("voice-select");
      select.innerHTML = "";

      // Prioritize Google English voices
      const englishVoices = voices.filter(v => v.lang && v.lang.startsWith("en"));
      englishVoices.sort((a, b) => {
        const aGoogle = a.name.toLowerCase().includes("google");
        const bGoogle = b.name.toLowerCase().includes("google");
        if (aGoogle && !bGoogle) return -1;
        if (!aGoogle && bGoogle) return 1;
        return (a.name || "").localeCompare(b.name || "");
      });

      englishVoices.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v.name;
        opt.textContent = v.name + " (" + v.lang + ")";
        select.appendChild(opt);
      });
    }
    speechSynthesis.onvoiceschanged = loadVoices;
    window.onload = loadVoices;

    // === Speak with SpeechSynthesis ===
    function speakWithVoice(text) {
      return new Promise(resolve => {
        const utter = new SpeechSynthesisUtterance(text);
        const voiceName = document.getElementById('voice-select').value;
        const voices = speechSynthesis.getVoices();
        const voice = voices.find(v => v.name === voiceName);
        if (voice) utter.voice = voice;
        utter.onend = resolve;
        speechSynthesis.speak(utter);
      });
    }

    function addMessage(who, text) {
      const d = document.createElement('div');
      d.className = `message ${who}`;
      let label = who === 'user' ? userName || "A" : botName || "B";
      d.textContent = `${label}: ${text}`;
      conversationDiv.appendChild(d);
      transcript.push({ who, text });
      conversationDiv.scrollTop = conversationDiv.scrollHeight;
    }

    document.getElementById("startBtn").onclick = startConversation;
    document.getElementById("studentName").addEventListener("keydown", e => {
      if (e.key === "Enter") startConversation();
    });

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function startConversation() {
      if (conversationStarted) return;
      userName = document.getElementById("studentName").value.trim();
      if (!userName) {
        alert("Please enter your name.");
        return;
      }

      // increment local attempts for this student/assignment
      attemptCount = incrementAttempts(userName);

      botName = capitalize(document.getElementById('voice-select').value || '');
      document.getElementById("startBtn").disabled = true;
      document.getElementById("studentName").disabled = true;
      conversationDiv.innerHTML = "";
      transcript.length = 0;
      currentLine = 0;
      conversationStarted = true;

      let firstLine = scriptLines[0].replace("NAME", botName);
      addMessage('user', firstLine);
      document.getElementById("recordButton").disabled = false;
      awaitingUser = true;
    }

    function showBotReply() {
      if (currentLine < botLines.length) {
        setTimeout(() => {
          addMessage('bot', botLines[currentLine]);
          speakWithVoice(botLines[currentLine]).then(() => {
            currentLine++;
            if (currentLine < scriptLines.length) {
              addMessage('user', scriptLines[currentLine].replace("NAME", botName));
              document.getElementById("recordButton").disabled = false;
              awaitingUser = true;
            } else {
              document.getElementById("pdfBtn").disabled = false;
            }
          });
        }, 800);
      } else {
        document.getElementById("pdfBtn").disabled = false;
      }
    }

    function startRecording() {
      const recog = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recog.lang = 'en-US'; recog.interimResults = false; recog.maxAlternatives = 1;
      recog.start();
      recog.onresult = e => {
        tempUserText = e.results[0][0].transcript;
        document.getElementById("studentInput").value = tempUserText;
        document.getElementById("sendButton").disabled = false;
      };
      recog.onerror = e => alert("Speech recognition error: " + e.error);
    }

    function submitUserResponse() {
      if (!tempUserText || !awaitingUser) return;
      transcript.push({ who: "counselorResponse", text: tempUserText });
      document.getElementById("studentInput").value = "";
      document.getElementById("sendButton").disabled = true;
      document.getElementById("recordButton").disabled = true;
      tempUserText = "";
      awaitingUser = false;
      showBotReply();
    }
    document.getElementById("sendButton").onclick = submitUserResponse;

    // === PDF EXPORT ===
    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const name = userName || 'A';
      const date = document.getElementById('sessionDate').textContent || new Date().toLocaleDateString();

      // Ensure attemptCount is set; if not, read from storage
      if (!attemptCount) attemptCount = getAttempts(userName) || 0;

      const dateWithAttempt = `${date} -${attemptCount}`;

      doc.setTextColor(0, 0, 0);
      doc.text(`Conversation Transcript\nA: ${name}\nB: ${botName}\nDate: ${dateWithAttempt}`, 10, 10);
      let y = 35;
      transcript.forEach(entry => {
        let whoLabel = entry.who === 'bot' ? botName : entry.who === 'user' ? name : 'A';
        doc.setTextColor(entry.who === 'bot' ? 0 : 11, entry.who === 'bot' ? 150 : 46, entry.who === 'bot' ? 0 : 138);
        const lines = doc.splitTextToSize(`${whoLabel}: ${entry.text}`, 180);
        lines.forEach(line => {
          doc.text(line, 10, y);
          y += 10;
          if (y > 280) { doc.addPage(); y = 20; }
        });
      });

      const safeDate = (date.replace(/[\/]/g, '-') + `-${attemptCount}`);
      const filename = `${name.replace(/\s+/g, '_')}_${safeDate}_unit2_student.pdf`;
      doc.save(filename);
    }
    document.getElementById("pdfBtn").onclick = downloadPDF;
  </script>
</body>
</html>
