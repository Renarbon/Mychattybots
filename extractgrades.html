<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Averages Viewer</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 30px;
    background: #f7f7f7;
  }
  h1 {
    color: #333;
  }
  input[type="file"] {
    margin-bottom: 20px;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    background: white;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
  }
  th {
    background: #4CAF50;
    color: white;
  }
  tr:nth-child(even) {
    background: #f2f2f2;
  }
  button {
    margin-top: 20px;
    padding: 10px 15px;
    background-color: #4CAF50;
    border: none;
    color: white;
    border-radius: 5px;
    cursor: pointer;
  }
</style>
</head>
<body>
  <h1>Student Averages Viewer</h1>
  <input type="file" id="fileInput" accept=".xlsx, .xls" />
  <div id="output"></div>
  <button id="exportCsv" style="display:none;" disabled>Export CSV</button>

  <script>
    document.getElementById('fileInput').addEventListener('change', handleFile, false);
    document.getElementById('exportCsv').addEventListener('click', exportCSV);

    let finalData = [];

    function handleFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });

        // Get Online Practice and Test Generator sheets
        const onlineSheet = workbook.Sheets["Online Practice"];
        const testSheet = workbook.Sheets["Test Generator"];

        if (!onlineSheet || !testSheet) {
          alert("The file must contain 'Online Practice' and 'Test Generator' sheets.");
          document.getElementById('exportCsv').style.display = 'none';
          document.getElementById('exportCsv').disabled = true;
          return;
        }

        const onlineData = XLSX.utils.sheet_to_json(onlineSheet);
        const testData = XLSX.utils.sheet_to_json(testSheet);

        const studentScores = {};

        // Process Online Practice (Assignments)
        onlineData.forEach(row => {
          const name = row["Student Name"] || row["Name"];
          if (!name) return;
          const scores = Object.values(row).filter(v => typeof v === "number");
          const avg = scores.length ? (scores.reduce((a,b)=>a+b,0)/scores.length) : 0;
          if (!studentScores[name]) studentScores[name] = {};
          studentScores[name].assignmentAvg = avg;
        });

        // Process Test Generator (Tests)
        testData.forEach(row => {
          const name = row["Student Name"] || row["Name"];
          if (!name) return;
          const scores = Object.values(row).filter(v => typeof v === "number");
          const avg = scores.length ? (scores.reduce((a,b)=>a+b,0)/scores.length) : 0;
          if (!studentScores[name]) studentScores[name] = {};
          studentScores[name].testAvg = avg;
        });

        // Combine data
        finalData = Object.entries(studentScores).map(([name, data]) => ({
          "Student Name": name,
          "Assignments Average": (data.assignmentAvg || 0).toFixed(2),
          "Tests Average": (data.testAvg || 0).toFixed(2)
        }));

        displayTable(finalData);

        // Show and enable export button if there is data
        const exportBtn = document.getElementById('exportCsv');
        exportBtn.style.display = finalData.length ? 'inline-block' : 'none';
        exportBtn.disabled = !finalData.length;
      };
      reader.readAsArrayBuffer(file);
    }

    function displayTable(data) {
      if (data.length === 0) return;
      let html = '<table><thead><tr>';
      Object.keys(data[0]).forEach(key => html += `<th>${key}</th>`);
      html += '</tr></thead><tbody>';
      data.forEach(row => {
        html += '<tr>';
        Object.values(row).forEach(val => html += `<td>${val}</td>`);
        html += '</tr>';
      });
      html += '</tbody></table>';
      document.getElementById('output').innerHTML = html;
    }

    // Escape CSV values for safety
    function escapeCsvValue(val) {
      if (val == null) return '';
      val = String(val);
      if (/[",\n]/.test(val)) {
        val = '"' + val.replace(/"/g, '""') + '"';
      }
      return val;
    }

    function exportCSV() {
      if (finalData.length === 0) return;
      const headers = Object.keys(finalData[0]);
      const rows = finalData.map(row => headers.map(h => escapeCsvValue(row[h])).join(","));
      const csvContent = headers.join(",") + "\n" + rows.join("\n");
      const blob = new Blob([csvContent], { type: "text/csv" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "student_averages.csv";
      document.body.appendChild(a); // Required for Firefox
      a.click();
      document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(url), 1000); // Delay to ensure download works
    }
  </script>
</body>
</html>
